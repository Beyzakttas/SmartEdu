<%- include('partials/_header');%>
<%- include('partials/_navigation');%>

<% if(user) { %>

    <div class="all-title-box">
        <div class="container text-center">
            <h1><%= user.name %><span class="m_1 text-uppercase"><%= user.role %></span></h1>
        </div>
    </div>

    <div id="overviews" class="section wb">
        <div class="container">
            
            <% if (flashMessages) { %>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <% if (flashMessages.success) { %>
                    <script>
                        Swal.fire({ icon: 'success', title: 'Başarılı!', text: '<%= flashMessages.success %>', showConfirmButton: false, timer: 2000 });
                    </script>
                <% } else if (flashMessages.error) { %>
                    <script>
                        Swal.fire({ icon: 'error', title: 'Hata!', text: '<%= flashMessages.error %>' });
                    </script>
                <% } %>
            <% } %>

            <% if(user.role === 'admin' && typeof totalCourses !== 'undefined') { %>
                <div class="row mt-5 mb-5 text-white">
                    <div class="col-lg-4 col-md-4 col-12">
                        <div class="p-4 text-center rounded bg-warning shadow">
                            <i class="fa fa-book fa-3x mb-2"></i>
                            <h3>TOTAL COURSES</h3>
                            <p class="h2 font-weight-bold"><%= totalCourses %></p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-12">
                        <div class="p-4 text-center rounded bg-info shadow">
                            <i class="fa fa-users fa-3x mb-2"></i>
                            <h3>TOTAL STUDENTS</h3>
                            <p class="h2 font-weight-bold"><%= totalStudents %></p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-12">
                        <div class="p-4 text-center rounded bg-danger shadow">
                            <i class="fa fa-list fa-3x mb-2"></i>
                            <h3>TOTAL CATEGORIES</h3>
                            <p class="h2 font-weight-bold"><%= totalCategories %></p>
                        </div>
                    </div>
                </div>
            <% } %>

            <div class="row">
                <div class="col-lg-12 blog-post-single">
                    <div class="blog-author">
                        <div class="author-bio">
                            <h3 class="author_name">COURSES FROM: <%= user.name %></h3>
                            <h5>Role: <span class="badge badge-warning text-white"><%= user.role %></span></h5>
                        </div>
                    </div>
                </div>
            </div>

            <% if(user.role === 'student') { %>
                <div class="row mt-5">
                    <% for (let i=0; i < user.courses.length; i++) { %>
                    <div class="col-lg-6 col-md-6 col-12">
                        <div class="course-item mb-5" style="border: 1px solid #4babb1; overflow: hidden;">
                            <div class="course-br" style="padding: 15px;">
                                <div class="course-title">
                                    <h2 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        <a href="/courses/<%= user.courses[i].slug %>"><%= user.courses[i].name %></a>
                                    </h2>
                                </div>
                                <div class="course-desc">
                                    <p style="white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; display: block !important; width: 100% !important; word-break: break-all !important; margin-bottom: 15px;">
                                        <%= user.courses[i].description.substring(0, 100) %>
                                    </p>
                                </div>
                                <form id="releaseForm-<%= user.courses[i]._id %>" method="POST" action="/courses/release">
                                    <input type="hidden" name="course_id" value="<%= user.courses[i]._id %>">
                                    <button type="button" class="btn btn-outline-danger" onclick="confirmRelease('<%= user.courses[i]._id %>')">
                                        <span>RELEASE</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            <% } %>

            <% if(user.role === 'teacher') { %>
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button class="btn btn-lg btn-warning rounded-0 text-white" data-toggle="modal" data-target="#addCourse">
                            <span>CREATE NEW COURSE</span>
                        </button>
                    </div>
                </div>

                <div class="row mt-5">
                    <% for (let i=0; i < courses.length; i++) { %>
                    <div class="col-lg-6 col-md-6 col-12">
                        <div class="course-item mb-5" style="border: 1px solid #4babb1; overflow: hidden;">
                            <div class="image-blog">
                                <img src="<%= courses[i].image %>" alt="" class="img-fluid" style="height: 200px; width: 100%; object-fit: cover;">
                            </div>
                            <div class="course-br" style="padding: 15px;">
                                <div class="course-title">
                                    <h2 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        <a href="/courses/<%= courses[i].slug %>"> <%= courses[i].name %></a>
                                    </h2>
                                </div>
                                <div class="course-desc">
                                    <p style="white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; display: block !important; width: 100% !important; word-break: break-all !important; margin-bottom: 15px;">
                                        <%= courses[i].description.substring(0, 100) %>
                                    </p>
                                </div>
                                <div class="clearfix">
                                    <ul style="list-style-type: none; padding: 0;">
                                      <li style="float: left;">
                                          <button class="btn btn-primary rounded-0 text-white" data-toggle="modal" data-target="#updateCourse<%= courses[i]._id %>">
                                              <span>UPDATE</span>
                                          </button>
                                      </li>
                                      <li style="float: right;">
                                          <a href="javascript:void(0)" onclick="confirmTeacherDelete('/courses/<%= courses[i].slug %>?_method=DELETE')" class="btn btn-danger rounded-0 text-white">
                                              <span>DELETE</span>
                                          </a>
                                      </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="updateCourse<%= courses[i]._id %>" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-body customer-box">
                                    <form method="POST" action="/courses/<%= courses[i].slug %>?_method=PUT" enctype="multipart/form-data">
                                        <div class="form-group"><input type="text" name="name" value="<%= courses[i].name %>" class="form-control" required></div>
                                        <div class="form-group"><textarea rows="5" name="description" class="form-control" required><%= courses[i].description %></textarea></div>
                                        <div class="form-group">
                                            <label>Current Image:</label><br>
                                            <img src="<%= courses[i].image %>" style="width: 100px; margin-bottom: 10px;">
                                            <input type="file" name="image" class="form-control-file">
                                        </div>
                                        <div class="form-group">
                                         <select class="form-control" name="category">
    <% for (let j=0; j < categories.length; j++) { %>
        <option value="<%= categories[j]._id %>" 
            <%= String(categories[j]._id) === String(courses[i].category._id || courses[i].category) ? 'selected' : '' %>>
            <%= categories[j].name %>
        </option>
    <% } %>
</select>
                                        </div>
                                        <button type="submit" class="btn btn-light btn-radius btn-brd grd1">SUBMIT CHANGES</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            <% } %>

            <% if(user.role === 'admin') { %>
                <div class="row mt-5">
                    <div class="col-lg-12">
                        <h2 class="mb-3">Admin Panel: Users List</h2>
                        <table class="table table-hover border">
                            <thead style="background-color: #f8f9fa; border-bottom: 2px solid #eea412;">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th class="text-right" style="padding-right: 20px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (let i=0; i < users.length; i++) { %>
                                    <tr>
                                        <td><%= users[i].name %></td>
                                        <td><%= users[i].email %></td>
                                        <td><span class="badge badge-info"><%= users[i].role %></span></td>
                                        <td class="text-right" style="padding-right: 20px;">
                                            <button class="btn btn-primary btn-sm rounded-0 text-white" data-toggle="modal" data-target="#editUser<%= users[i]._id %>">
                                                <span>UPDATE</span>
                                            </button>
                                            <a href="javascript:void(0)" 
                                               onclick="confirmAdminDelete('/users/<%= users[i]._id %>?_method=DELETE', '<%= users[i].name %>')" 
                                               class="btn btn-danger btn-sm rounded-0 text-white ml-1">
                                               <span>DELETE</span>
                                            </a>
                                        </td>
                                    </tr>

                                    <div class="modal fade" id="editUser<%= users[i]._id %>" tabindex="-1" role="dialog">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-body customer-box">
                                                    <h3 class="mb-4">Edit User: <%= users[i].name %></h3>
                                                    <form method="POST" action="/users/<%= users[i]._id %>?_method=PUT">
                                                        <div class="form-group"><input type="text" name="name" value="<%= users[i].name %>" class="form-control" required></div>
                                                        <div class="form-group"><input type="email" name="email" value="<%= users[i].email %>" class="form-control" required></div>
                                                        <div class="form-group">
                                                            <select class="form-control" name="role">
                                                                <option value="student" <%= users[i].role === 'student' ? 'selected' : '' %>>Student</option>
                                                                <option value="teacher" <%= users[i].role === 'teacher' ? 'selected' : '' %>>Teacher</option>
                                                                <option value="admin" <%= users[i].role === 'admin' ? 'selected' : '' %>>Admin</option>
                                                            </select>
                                                        </div>
                                                        <button type="submit" class="btn btn-warning text-white btn-radius">SAVE CHANGES</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-5">
                    <div class="col-lg-12">
                        <h2 class="mb-3">Admin Panel: Categories List</h2>
                        <button class="btn btn-warning rounded-0 text-white mb-3" data-toggle="modal" data-target="#addCategory">
                            <span>ADD NEW CATEGORY</span>
                        </button>
                        <table class="table table-hover border">
                            <thead style="background-color: #f8f9fa; border-bottom: 2px solid #eea412;">
                                <tr>
                                    <th>Category Name</th>
                                    <th class="text-right" style="padding-right: 20px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (let i=0; i < categories.length; i++) { %>
                                    <tr>
                                        <td><%= categories[i].name %></td>
                                        <td class="text-right" style="padding-right: 20px;">
                                            <button class="btn btn-primary btn-sm rounded-0 text-white" data-toggle="modal" data-target="#editCategory<%= categories[i]._id %>">
                                                <span>UPDATE</span>
                                            </button>
                                            <a href="javascript:void(0)" 
                                               onclick="confirmAdminDelete('/categories/<%= categories[i]._id %>?_method=DELETE', '<%= categories[i].name %>')" 
                                               class="btn btn-danger btn-sm rounded-0 text-white ml-1">
                                               <span>DELETE</span>
                                            </a>
                                        </td>
                                    </tr>

                                    <div class="modal fade" id="editCategory<%= categories[i]._id %>" tabindex="-1" role="dialog">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-body customer-box">
                                                    <h3 class="mb-4">Edit Category</h3>
                                                    <form method="POST" action="/categories/<%= categories[i]._id %>?_method=PUT">
                                                        <div class="form-group"><input type="text" name="name" value="<%= categories[i].name %>" class="form-control" required></div>
                                                        <button type="submit" class="btn btn-warning text-white btn-radius">UPDATE CATEGORY</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal fade" id="addCategory" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-body customer-box">
                                <h3 class="mb-4">Add New Category</h3>
                                <form method="POST" action="/categories">
                                    <div class="form-group">
                                        <input type="text" name="name" class="form-control" placeholder="Category Name" required>
                                    </div>
                                    <button type="submit" class="btn btn-warning text-white btn-radius">SUBMIT</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

        </div></div><div class="modal fade" id="addCourse" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body customer-box">
                    <form method="POST" action="/courses" enctype="multipart/form-data">
                        <div class="form-group"><input type="text" name="name" class="form-control" placeholder="Course Name" required></div>
                        <div class="form-group"><textarea rows="5" name="description" class="form-control" placeholder="Description" required></textarea></div>
                        <div class="form-group"><input type="file" name="image" class="form-control-file"></div>
                        <div class="form-group">
                            <select class="form-control" name="category">
                                <% for (let i=0; i < categories.length; i++) { %>
                                    <option value="<%= categories[i]._id %>"><%= categories[i].name %></option>
                                <% } %>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-light btn-radius btn-brd grd1">CREATE</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<% } %>

<%- include('partials/_footer');%>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmAdminDelete(deleteUrl, itemName) {
    Swal.fire({
        title: 'Emin misiniz?',
        text: `"${itemName}" kalıcı olarak silinecek!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Evet, sil!',
        cancelButtonText: 'Vazgeç'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = deleteUrl;
        }
    })
}

function confirmTeacherDelete(deleteUrl) {
    Swal.fire({
        title: 'Emin misiniz?',
        text: "Bu kurs tamamen silinecek!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Evet, sil!',
        cancelButtonText: 'Vazgeç'
    }).then((result) => {
        if (result.isConfirmed) window.location.href = deleteUrl;
    })
}

function confirmRelease(courseId) {
    Swal.fire({
        title: 'Emin misiniz?',
        text: "Bu kurs listenizden çıkarılacak!",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#eea412',
        confirmButtonText: 'Evet, bırakıyorum!'
    }).then((result) => {
        if (result.isConfirmed) document.getElementById('releaseForm-' + courseId).submit();
    })
}
</script>